language: php

sudo: true

php:
  - 7.0
  
before_install:
  - echo "extension = ldap.so" >> ~/.phpenv/versions/$(phpenv version-name)/etc/php.ini
  - sudo apt-get install php5-ldap
  
install:
  - curl -s http://getcomposer.org/installer | php
  - php composer.phar install --dev --no-interaction

before_script:
  - sh -c "composer require 'cakephp/cakephp-codesniffer:dev-master'"
  - phpenv rehash

script:
  - mkdir -p build/logs
  - php vendor/bin/phpunit -c phpunit.xml.dist
  - sh -c "vendor/bin/phpcs -p --extensions=php --standard=vendor/cakephp/cakephp-codesniffer/CakePHP ./src ./tests ./config ./webroot"

after_success:
  - travis_retry php vendor/bin/coveralls
  - travis_retry php vendor/bin/coveralls -v
  - docker --version  # document the version travis is using
  - pip install --user awscli # install aws cli w/o sudo
  - export PATH=$PATH:$HOME/.local/bin # put aws in the path
  - eval $(aws ecr get-login --region us-east-1) #needs AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY envvars
  - docker build -t makermanager .
  - docker tag makermanager:latest $ECR_ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/makermanager:build-$TRAVIS_BUILD_NUMBER
  - docker push $ECR_ACCOUNT.dkr.ecr.us-east-1.amazonaws.com/makermanager:build-$TRAVIS_BUILD_NUMBER

notifications:
  email:
    on_success: never
    on_failure: always
